# Example - define HRUs based on the existing lake-river routing structure and generate Raven model inputs
 
# Overview
In this example, the existing lake-river routing structure will be used to define hrus, and raven model inputs will be generated.
 
```
python example_generate_hrus_and_model_inputs.py
```

# Explanation of script 

## Define the working and output folder 
The working folder is the folder where basinmaker will save all geo spatial files generated during the watershed delineation; while the output folder is the folder the basinmaker will save final outputs.

```
#############################################
# define working folder, output folder amd data folder  
#############################################
num  = str(np.random.randint(1, 10000 + 1))
path_output_folder = os.path.join(tempfile.gettempdir(), "basinmaker_exp_" +num,"output")
path_working_folder = os.path.join(tempfile.gettempdir(), "basinmaker_exp_" +num,"work")
datafolder = os.path.join("../../tests/testdata", "existing_lake_river_routing_structure")
demfolder = os.path.join("../../tests/testdata", "Required_data_to_start_from_dem")
HRU_Folder = os.path.join("../../tests/testdata/", "HRU")
```


## Initialize basinmaker 
The basinmaker can be initialized with path to the working folder 
```

```

## generate hrus 

### parameters 

* \<OutputFolder\> 
      is the folder that stores generated outputs
      
* \<Path_Subbasin_Ply\> 
      It is the path of the subbasin polygon, which is generated by toolbox. if not generated by toolbox, the attribute table should including following attribute.
      
* \<Path_Connect_Lake_ply\> 
      Path to the river polyline which is the routing product before merging lakes catchments and need to be processed before used. It is the input for simplify the routing product based on lake area or drianage area.
      
* \<Lake_Id\> 
      The the column name in lake polygon indicate the lake ID.
      
* \<Path_Landuse_Ply\> 
      Path to the landuse polygon. when Path_Landuse_Ply is not provided. The Landuse ID in Landuse_info should be 1: land, -1: lake

* \<Landuse_ID\> 
      the the column name in landuse polygon and Landuse_info csv indicate the landuse ID. when Path_Landuse_Ply is not provided. The Landuse ID should be 1: land, -1: lake.

* \<Path_Soil_Ply\>
      Path to the soil polygon. when soil polygon is not provided. The Soil ID in Soil_info should be the same as Landuse ID.

* \<Soil_ID\> 
      the the column name in soil polygon and soil_info csv indicate the soil ID. when soil polygon is not provided. The Soil ID in Soil_info should be the same as Landuse ID.

* \<Path_Veg_Ply\> 
      Path to the vegetation polygon. when Veg polygon is not provided. The Veg ID in Veg_info should be the same as Landuse ID.

* \<Veg_ID\> 
      the the column name in vegetation polygon and veg_info csv indicate the vegetation ID. when Veg polygon is not provided. The Veg ID in Veg_info should be the same as Landuse ID.

* \<Path_Other_Ply_1\> 
      Path to the other polygon that will be used to define HRU, such as elevation band, or aspect.

* \<Other_Ply_ID_1\> 
      the the column name in Other_Ply_1 polygon indicate the unique type ID.

* \<Path_Other_Ply_2\> 
      Path to the other polygon that will be used to define HRU, such as elevation band, or aspect.

* \<Other_Ply_ID_2\> 
      the the column name in Other_Ply_2 polygon indicate the unique type ID.

* \<Landuse_info\> 
      Path to a csv file that contains landuse information, including following attributes: Landuse_ID (integer) the landuse ID in the landuse polygon; LAND_USE_C(string),the landuse class name for each landuse type

* \<Soil_info\> 
      Path to a csv file that contains soil information, including following attributes: Soil_ID (integer) the soil ID in the soil polygon; SOIL_PROF(string),the soil profile name for each soil type

* \<Veg_info\>
      Path to a csv file that contains vegetation information, including following attributes: Veg_ID (integer) the vegetation ID in the vegetation polygon; VEG_C(string),the vegetation name for each vegetation type

* \<DEM\> 
      the path to a raster elevation dataset, that will be used to calcuate average apspect, elevation and slope within each HRU. if no data is provided, basin average value will be used for each HRU.

* \<gis_platform\> 
      It is the parameter indicate which gis platform is used. For now only "qgis" is supported   

        
```
#############################################
# define hurs    
#############################################
basinmaker.generate_hrus_methods(
    OutputFolder=path_output_folder,
    Path_Subbasin_Ply=os.path.join(
        datafolder, "finalcat_info.shp"
    ),
    Path_Connect_Lake_ply=os.path.join(
        datafolder, "sl_connected_lake.shp"
    ),
    Path_Non_Connect_Lake_ply=os.path.join(
        datafolder, "sl_non_connected_lake.shp"
    ),
    Lake_Id="Hylak_id",    
    Path_Landuse_Ply="#",
    Landuse_ID="Landuse_ID",
    Path_Soil_Ply="#",
    Soil_ID="Soil_ID",
    Path_Veg_Ply="#",
    Veg_ID="Veg_ID",
    Path_Other_Ply_1="#",
    Other_Ply_ID_1="O_ID_1",
    Path_Other_Ply_2="#",
    Other_Ply_ID_2="O_ID_2",
    Landuse_info=os.path.join(HRU_Folder, "landuse_info.csv"),
    Soil_info=os.path.join(HRU_Folder, "soil_info.csv"),
    Veg_info=os.path.join(HRU_Folder, "veg_info.csv"),
    DEM=os.path.join(demfolder, "oih_30_dem.tif"),
    gis_platform="qgis",
)
```

### outputs  
* \<finalcat_hru_info.shp\> 
      is generated hru polygon with attributes  



## generate Raven model inputs
In this step, the attributes in the generated hru polygon will be used to generate raven input files.

### parameters 

* \<path_final_hru_info\> 
      Path of the output shapefile from routing toolbox which includes all required parameters; Each row in the attribute table of this shapefile represent a HRU.

* \<startyear\> 
      Start year of simulation. Used to read streamflow observations from external databases.

* \<endYear\> 
      End year of simulation. Used to read streamflow observations from external databases.

* \<CA_HYDAT\> 
      path and filename of downloaded external database containing streamflow observations, e.g. HYDAT for Canada ("Hydat.sqlite3").

* \<warmup\> 
      The warmup time (in years) used after startyear. Values in output file "obs/xxx.rvt" containing observations will be set to NoData value "-1.2345" from model start year to end of WarmUp year.

* \<template_folder\> 
      Input that is used to copy raven template files. It is a folder name containing raven template files. All files from that folder will be copied (unchanged) to the "<OutputFolder>/RavenInput".

* \<lake_as_gauge\>
      Path to the soil polygon. when soil polygon is not provided. The Soil ID in Soil_info should be the same as Landuse ID.

* \<writeobsrvt\> 
      Input that used to indicate if the observation data file needs to be generated.

* \<downloadobsdata\> 
      Input that used to indicate if the observation data will be Download from usgs website or read from hydat database for streamflow Gauge in US or Canada,respectively. If this parameter is False, while WriteObsrvt is True. The program will write the observation data file with "-1.2345" for each observation gauges.

* \<model_name\> 
      The Raven model base name. File name of the raven input will be Model_Name.xxx.

* \<subbasingroup_nm_channel\> 
      It is a list of names for subbasin groups, which are grouped based on channel length of each subbsin. Should at least has one name

* \<subbasingroup_length_channel\> 
      It is a list of float channel length thresthold in meter, to divide subbasin into different groups. for example, [1,10,20] will divide subbasins into four groups, group 1 with channel length (0,1]; group 2 with channel length (1,10]; group 3 with channel length (10,20]; group 4 with channel length (20,Max channel length].

* \<subbasingroup_nm_lake\> 
      It is a list of float lake area thresthold in m2, to divide subbasin into different groups. for example, [1,10,20] will divide subbasins into four groups, group 1 with lake area (0,1]; group 2 with lake are (1,10], group 3 with lake are (10,20], group 4 with lake are (20,Max channel length].

* \<subbasingroup_area_lake\> 
      the the column name in Other_Ply_2 polygon indicate the unique type ID.

* \<outputfolder\> 
      Folder name that stores generated Raven input files. The raven input file will be generated in "<OutputFolder>/RavenInput"
```
basinmaker.generate_raven_model_inputs_method(
    path_final_hru_info=os.path.join(path_output_folder,'finalcat_hru_info.shp'),
    startyear=2010,
    endYear=2014,
    CA_HYDAT="#",
    warmup=1,
    template_folder="#",
    lake_as_gauge=False,
    writeobsrvt=False,
    downloadobsdata=False,
    model_name="test",
    subbasingroup_nm_channel=["Allsubbasins"],
    subbasingroup_length_channel=[-1],
    subbasingroup_nm_lake=["AllLakesubbasins"],
    subbasingroup_area_lake=[-1],
    outputfolder=path_output_folder,
)
```
### outputs  
* \<modelname.rvh\> 
* \<Lakes.rvh\> 
* \<channel_properties.rvp\> 
* \</obs/xxx.rvt.rvh\> 
* \<obsinfo.csv\> 
